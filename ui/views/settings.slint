import { Button, LineEdit, CheckBox, VerticalBox, HorizontalBox, ComboBox } from "std-widgets.slint";

// --- POMOCN√â KOMPONENTY ---

// Nov√° komponenta pro ≈ô√°dek s v√Ωbƒõrem cesty
component PathSelectorRow inherits HorizontalLayout {
    in property <string> label;
    in property <string> path;
    callback change-clicked();

    spacing: 15px;
    height: 35px;

    Text {
        text: root.label;
        color: #aaa;
        vertical-alignment: center;
        width: 180px;
        font-size: 14px;
    }

    Rectangle {
        background: #111;
        border-radius: 4px;
        border-width: 1px;
        border-color: #333;
        horizontal-stretch: 1;
        
        Text {
            text: root.path == "" ? "Cesta nebyla nastavena..." : root.path;
            color: root.path == "" ? #555 : #4aa3df;
            vertical-alignment: center;
            x: 10px;
            width: parent.width - 20px;
            overflow: elide;
            font-family: "monospace";
        }
    }

    Button {
        text: "Zmƒõnit";
        width: 80px;
        clicked => { root.change-clicked(); }
    }
}

// Definice ProgressBaru podle va≈°eho n√°vrhu
export component ProgressBar inherits Rectangle {
    in property <float> progress: 0.0; 
    in property <string> status_text: "Pracuji...";
    
    height: 100px;
    width: 400px;
    background: #252525;
    border-radius: 12px;
    border-width: 2px;
    border-color: #3d3d3d;

    VerticalLayout {
        padding: 20px;
        spacing: 12px;
        alignment: center;

        HorizontalLayout {
            Text {
                text: root.status_text;
                color: white;
                font-size: 14px;
                font-weight: 600;
            }
            Rectangle { horizontal-stretch: 1; }
            Text {
                text: "\{round(root.progress * 100)}%";
                color: #888;
                font-size: 14px;
            }
        }

        Rectangle {
            height: 12px;
            background: #1a1a1a;
            border-radius: 6px;
            clip: true;

            Rectangle {
                x: 0;
                width: parent.width * root.progress;
                height: parent.height;
                background: #4aa3df;
                border-radius: 6px;
                animate width { duration: 250ms; easing: ease-out; }
            }
        }
    }
}

component StatusCard inherits Rectangle {
    in property <string> title;
    in property <string> symbol; 
    in property <string> description;
    in property <color> base-color;
    in property <bool> active: false;
    
    callback clicked();

    width: 600px; 
    height: 180px;
    background: touch.has-hover ? #2e2e2e : #252525;
    border-radius: 16px;
    border-width: 2px;
    border-color: active ? white : (touch.has-hover ? root.base-color.brighter(20%) : root.base-color.darker(30%));

    animate background { duration: 150ms; }
    animate border-color { duration: 100ms; }

    touch := TouchArea {
        mouse-cursor: pointer; 
        clicked => { root.clicked(); }
    }

    HorizontalLayout {
        padding: 30px;
        spacing: 30px;

        Rectangle {
            width: 100px;
            Text { 
                text: root.symbol; 
                font-size: 80px;
                font-weight: 900;
                color: root.base-color;
                vertical-alignment: center; 
                horizontal-alignment: center;
            }
        }

        VerticalLayout {
            alignment: center;
            spacing: 8px;
            Text {
                text: root.title; 
                font-size: 24px; 
                font-weight: 800; 
                color: white;
            }
            Text {
                text: root.description; 
                font-size: 14px; 
                color: #888;
                wrap: word-wrap;
            }
        }
    }
}

component FilterCard inherits Rectangle {
    in property <string> label;
    in property <string> count;
    in property <color> count-color: white;
    in property <bool> active: false;
    in property <string> icon;
    
    callback clicked();

    background: touch.has-hover ? #2e2e2e : #252525; 
    border-radius: 12px; 
    border-width: 2px;
    border-color: active ? #2CC985 : (touch.has-hover ? #4d4d4d : #3d3d3d);
    
    animate border-color { duration: 150ms; }
    animate background { duration: 150ms; }

    touch := TouchArea {
        clicked => { root.clicked(); }
    }

    HorizontalLayout {
        padding: 16px; 
        spacing: 15px;
        Text { 
            text: root.icon; 
            vertical-alignment: center; 
            font-size: 24px; 
        }
        VerticalLayout {
            alignment: center;
            Text { 
                text: root.label; 
                color: #888; 
                font-size: 11px; 
                font-weight: 700; 
            }
            Text { 
                text: root.count; 
                color: root.count-color; 
                font-size: 18px; 
                font-weight: 800; 
            }
        }
    }
}

component ImportDialog inherits Rectangle {
    in property <string> excel-path;
    in property <[string]> sheets;
    in-out property <string> selected-sheet;
    
    callback start-import();
    callback cancel();

    width: 600px;
    background: #252525;
    border-radius: 16px;
    border-width: 2px;
    border-color: #3d3d3d;

    VerticalLayout {
        padding: 30px;
        spacing: 20px;

        Text {
            text: "P≈ô√≠prava importu";
            font-size: 22px;
            font-weight: 800;
            color: white;
        }

        VerticalLayout {
            spacing: 5px;
            Text { text: "Vybran√Ω soubor:"; color: #888; font-size: 12px; }
            Rectangle {
                background: #1a1a1a;
                border-radius: 8px;
                height: 40px;
                HorizontalLayout {
                    padding-left: 15px; padding-right: 15px;
                    Text { 
                        text: root.excel-path; 
                        vertical-alignment: center; 
                        color: #4aa3df;
                        font-family: "monospace";
                        overflow: elide;
                    }
                }
            }
        }

        VerticalLayout {
            spacing: 5px;
            Text { text: "Vyberte list (Sheet):"; color: #888; font-size: 12px; }
            ComboBox {
                model: root.sheets;
                current-value <=> root.selected-sheet;
            }
        }

        HorizontalLayout {
            spacing: 15px;
            alignment: end;
            Button {
                text: "Zru≈°it";
                clicked => { root.cancel(); }
            }
            Button {
                text: "Spustit import dat";
                primary: true;
                enabled: root.excel-path != "" && root.selected-sheet != "";
                clicked => { root.start-import(); }
            }
        }
    }
}

// --- HLAVN√ç KOMPONENTA NASTAVEN√ç ---

export component SettingsView inherits Rectangle { 
    // API pro main.slint
    in property <int> db-status-code: 1; 
    in property <string> stav-text: "DATAB√ÅZE NEN√ç NAƒåTENA";
    in property <string> posledni-sync: "Nezn√°m√Ω";
    in property <int> pocet-celkem: 0;
    in property <int> pocet-chybi: 0;

    // API pro cesty (propojen√≠ s Rustem)
    in property <string> path-tech-docs: "";
    in property <string> path-production: "";
    in property <string> path-offers: "";

    // Progress a Import flow
    in property <string> excel-path: "";
    in property <[string]> available-sheets: ["List1", "Export"];
    in-out property <string> selected-sheet: "";
    
    in property <bool> show-progress: false;
    in property <float> progress-value: 0.0;
    in property <string> progress-label: "Prob√≠h√° import dat...";

    // Callbacks
    callback vybrat-soubor-databaze();
    callback spustit-import(string, string);
    callback reset-import-status();
    
    // Callbacks pro zmƒõnu cest
    callback change-tech-docs();
    callback change-production();
    callback change-offers();

    property <int> settings-tab: 0;

    background: #1a1a1a;

    VerticalLayout {
        padding: 25px;
        spacing: 25px;

        // Navigaƒçn√≠ Menu
        HorizontalLayout {
            height: 45px; 
            spacing: 12px;
            Button { text: "Aktualizace"; primary: root.settings-tab == 0; clicked => { root.settings-tab = 0; } }
            Button { text: "Partne≈ôi"; primary: root.settings-tab == 1; clicked => { root.settings-tab = 1; } }
            Button { text: "Syst√©m"; primary: root.settings-tab == 2; clicked => { root.settings-tab = 2; } }
        }

        Rectangle {
            // TAB 0: AKTUALIZACE
            if (root.settings-tab == 0) : VerticalLayout {
                spacing: 30px;
                alignment: start; 
                padding-top: 20px; 
                
                HorizontalLayout {
                    alignment: center;
                    if (root.excel-path == "") : StatusCard {
                        title: root.stav-text;
                        symbol: root.db-status-code == 0 ? "‚úì" : (root.db-status-code == 1 ? "!" : "‚úï");
                        base-color: root.db-status-code == 0 ? #2CC985 : (root.db-status-code == 1 ? #f39c12 : #e74c3c);
                        description: root.db-status-code == 0 ? 
                            "Data jsou aktu√°ln√≠. Kliknƒõte pro re-import z nov√©ho souboru." : 
                            "Kliknƒõte zde pro v√Ωbƒõr nov√©ho Excel souboru s partnery.";
                        clicked => { root.vybrat-soubor-databaze(); }
                    }

                    if (root.excel-path != "") : ImportDialog {
                        excel-path: root.excel-path;
                        sheets: root.available-sheets;
                        selected-sheet <=> root.selected-sheet;
                        cancel => { root.reset-import-status(); }
                        start-import => { root.spustit-import(root.excel-path, root.selected-sheet); }
                    }
                }
            }

            // TAB 1: PARTNE≈òI
            if (root.settings-tab == 1) : VerticalLayout {
                spacing: 20px;
                HorizontalLayout {
                    spacing: 20px;
                    FilterCard { 
                        label: "CELKEM"; 
                        count: root.pocet-celkem; 
                        icon: "üë•"; 
                        active: true; 
                    }
                    FilterCard { 
                        label: "BEZ SLO≈ΩKY"; 
                        count: root.pocet-chybi; 
                        icon: "üìÅ"; 
                        count-color: #e74c3c; 
                    }
                }
                Rectangle { background: #252525; border-radius: 12px; vertical-stretch: 1; }
            }

            // TAB 2: SYST√âM (Aktualizov√°no)
            if (root.settings-tab == 2) : VerticalLayout {
                padding: 20px;
                spacing: 20px;
                alignment: start;

                Text {
                    text: "Konfigurace syst√©mov√Ωch slo≈æek";
                    color: white;
                    font-size: 18px;
                    font-weight: 700;
                }

                PathSelectorRow {
                    label: "Technick√° dokumentace:";
                    path: root.path-tech-docs;
                    change-clicked => { root.change-tech-docs(); }
                }

                PathSelectorRow {
                    label: "Cesta do v√Ωroby:";
                    path: root.path-production;
                    change-clicked => { root.change-production(); }
                }

                PathSelectorRow {
                    label: "Cesta k nab√≠dk√°m:";
                    path: root.path-offers;
                    change-clicked => { root.change-offers(); }
                }

                Rectangle { vertical-stretch: 1; }

                HorizontalLayout {
                    Text { text: "Verze aplikace: 0.1.2"; color: #444; font-size: 12px; }
                }
            }
        }
    }

    // MODERN√ç PROGRESS OVERLAY
    if (root.show-progress) : Rectangle {
        background: #000000cc;
        
        TouchArea { } 

        ProgressBar {
            progress: root.progress-value;
            status_text: root.progress-label;
        }
    }
}